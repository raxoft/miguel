Sequel.migration do
  up do
    alter_table :b do
      add_index [:u], :unique => true
      add_index [:create_time], :unique => false
    end
    create_table :a_b do
      integer :left_id, :null => false, :key => [:id], :unsigned => false, :type => :integer
      integer :right_id, :null => false, :key => [:id], :unsigned => false, :type => :integer
      primary_key [:left_id, :right_id], :null => false, :unsigned => false
      index [:right_id, :left_id], :null => false, :unique => true
    end
    alter_table :a_b do
      add_foreign_key [:left_id], :a, :on_update => :no_action, :on_delete => :no_action, :key => [:id]
      add_foreign_key [:right_id], :b, :on_update => :no_action, :on_delete => :no_action, :key => [:id]
    end
  end
  down do
    alter_table :a_b do
      drop_foreign_key [:left_id] # :a, :on_update => :no_action, :on_delete => :no_action, :key => [:id]
      drop_foreign_key [:right_id] # :b, :on_update => :no_action, :on_delete => :no_action, :key => [:id]
    end
    drop_table :a_b
    alter_table :b do
      drop_index [:u] # :unique => true
      drop_index [:create_time] # :unique => false
    end
  end
end
